<!DOCTYPE html>
<html>
<head>
    <title>本登録</title>
</head>
<body>
<h1>本登録</h1>

{% if error %}
<p style="color:red;">{{ error }}</p>
{% endif %}

<form method="post">
{% csrf_token %}

<p>ISBN（必須）<br>
<input type="text" name="isbn" id="isbn" placeholder="978xxxxxxxxxxxx">
</p>

<button type="button" id="fetch-book">ISBNから本情報を取得</button>
<p id="fetch-status"></p>

<h2>バーコードでISBN読み取り</h2>

<button type="button" id="start-scan">カメラ起動</button>
<button type="button" id="stop-scan" disabled>停止</button>

<div id="scanner" style="width:360px;height:240px;border:1px solid #ccc;margin-top:10px;margin-bottom:16px;"></div>
<p id="scan-status"></p>

<hr>

<p>タイトル（必須）<br>
<input type="text" name="title" id="title" placeholder="本のタイトル">
</p>

<p>著者<br>
<input type="text" name="author" id="author" placeholder="著者名">
</p>

<p>出版社<br>
<input type="text" name="publisher" id="publisher" placeholder="出版社">
</p>

<p>表紙URL<br>
<input type="text" name="cover_url" id="cover_url" placeholder="https://...">
</p>

<p>棚（任意）<br>
<select name="shelf">
<option value="">未分類</option>
{% for s in shelves %}
<option value="{{ s.id }}">{{ s.name }}</option>
{% endfor %}
</select>
</p>

<p>メモ<br>
<textarea name="memo" rows="4" cols="40"></textarea>
</p>

<button type="submit">登録</button>
</form>

<p><a href="{% url 'book_list' %}">一覧へ戻る</a></p>

<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script>
const startBtn = document.getElementById("start-scan");
const stopBtn = document.getElementById("stop-scan");
const isbnInput = document.getElementById("isbn");
const scanStatus = document.getElementById("scan-status");

const fetchBtn = document.getElementById("fetch-book");
const fetchStatus = document.getElementById("fetch-status");

let scanning = false;

function normalizeIsbn(code) {
    return (code || "").replace(/[^0-9]/g, "");
}

// ===== カメラ処理 =====
function startScan() {
    if (scanning) return;
    scanning = true;

    scanStatus.textContent = "カメラ起動中...";
    startBtn.disabled = true;
    stopBtn.disabled = false;
    document.querySelector("#scanner").style.display = "block";

    Quagga.init({
        inputStream: {
            type: "LiveStream",
            target: document.querySelector("#scanner"),
            constraints: { facingMode: "environment" }
        },
        decoder: {
            readers: ["ean_reader", "ean_8_reader", "code_128_reader"]
        },
        locate: true
    }, function (err) {
        if (err) {
            scanStatus.textContent = "カメラ起動失敗";
            scanning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            return;
        }
        Quagga.start();
        scanStatus.textContent = "バーコードを映してください";
    });

    Quagga.onDetected(onDetected);
}

function stopScan() {
    if (!scanning) return;
    scanning = false;

    try {
        Quagga.offDetected(onDetected);
        Quagga.stop();
    } catch (e) {}

    document.querySelector("#scanner").style.display = "none";
    scanStatus.textContent = "停止しました";
    startBtn.disabled = false;
    stopBtn.disabled = true;
}

function onDetected(result) {
    const code = normalizeIsbn(result?.codeResult?.code);
    if (code.length === 13) {
        isbnInput.value = code;
        scanStatus.textContent = "読み取り成功: " + code;
        stopScan();
    }
}

// ===== ISBN検索処理 =====
fetchBtn.addEventListener("click", async () => {
    const isbn = isbnInput.value.trim().replaceAll("-", "");
    if (!isbn) {
        fetchStatus.textContent = "ISBNを入力してください";
        return;
    }

    fetchStatus.textContent = "取得中...";

    try {
        const res = await fetch(`/isbn-lookup/?isbn=${encodeURIComponent(isbn)}`);
        const data = await res.json();

        if (!data.ok) {
            fetchStatus.textContent = data.error || "見つかりませんでした";
            return;
        }

        document.getElementById("title").value = data.title || "";
        document.getElementById("author").value = data.author || "";
        document.getElementById("publisher").value = data.publisher || "";
        document.getElementById("cover_url").value = data.cover_url || "";

        fetchStatus.textContent = "取得できました！";
    } catch (e) {
        fetchStatus.textContent = "通信エラー";
    }
});

startBtn.addEventListener("click", startScan);
stopBtn.addEventListener("click", stopScan);
</script>

</body>
</html>