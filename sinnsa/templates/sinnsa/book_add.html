<!DOCTYPE html>
<html>

<head>
    <title>本登録</title>
</head>

<body>
    <h1>本登録</h1>

    {% if error %}
    <p style="color:red;">{{ error }}</p>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        <p>ISBN（必須）<br>
            <input type="text" name="isbn" id="isbn" placeholder="978xxxxxxxxxxxx">
        </p>
        <h2>バーコードでISBN読み取り</h2>

        <button type="button" id="start-scan">カメラ起動</button>
        <button type="button" id="stop-scan" disabled>停止</button>

        <div id="scanner" style="width: 360px; height: 240px; border: 1px solid #ccc; margin-top: 10px; margin-bottom: 16px;"></div>

        <p id="scan-status"></p>
        <hr>

        <p>タイトル（必須）<br>
            <input type="text" name="title" placeholder="本のタイトル">
        </p>

        <p>著者<br>
            <input type="text" name="author" placeholder="著者名">
        </p>

        <p>出版社<br>
            <input type="text" name="publisher" placeholder="出版社">
        </p>

        <p>表紙URL<br>
            <input type="text" name="cover_url" placeholder="https://...">
        </p>

        <p>棚（任意）<br>
            <select name="shelf">
                <option value="">未分類</option>
                {% for s in shelves %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>
        </p>

        <p>メモ<br>
            <textarea name="memo" rows="4" cols="40"></textarea>
        </p>

        <button type="submit">登録</button>
    </form>

    <p><a href="{% url 'book_list' %}">一覧へ戻る</a></p>
    <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

    <script>
        const startBtn = document.getElementById("start-scan");
        const stopBtn = document.getElementById("stop-scan");
        const isbnInput = document.getElementById("isbn");
        const statusEl = document.getElementById("scan-status");

        let scanning = false;

        function normalizeIsbn(code) {
            // EAN-13の数字だけにする
            return (code || "").replace(/[^0-9]/g, "");
        }

        function startScan() {
            if (scanning) return;
            scanning = true;

            statusEl.textContent = "カメラを起動しています...";
            startBtn.disabled = true;
            stopBtn.disabled = false;

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector("#scanner"),
                    constraints: {
                        facingMode: "environment"  // 背面カメラ優先
                    }
                },
                decoder: {
                    readers: [
                        "ean_reader",     // ISBN-13（EAN-13）
                        "ean_8_reader",
                        "code_128_reader"
                    ]
                },
                locate: true
            }, function (err) {
                if (err) {
                    console.error(err);
                    statusEl.textContent = "カメラ起動に失敗しました。HTTPS環境か確認してね。";
                    scanning = false;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    return;
                }
                Quagga.start();
                statusEl.textContent = "バーコードを枠内に映してください";
            });

            Quagga.onDetected(onDetected);
        }

        function stopScan() {
            if (!scanning) return;
            scanning = false;

            document.querySelector("#scanner").style.display = "block";

            try {
                Quagga.offDetected(onDetected);
                Quagga.stop();
            } catch (e) { }
            document.querySelector("#scanner").style.display = "none";

            statusEl.textContent = "停止しました";
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }

        function onDetected(result) {
            const code = normalizeIsbn(result?.codeResult?.code);
            if (!code) return;

            // 13桁くらいの時だけ採用（誤検出防止）
            if (code.length === 13) {
                isbnInput.value = code;
                statusEl.textContent = `読み取り成功：${code}`;
                stopScan(); // 1回読んだら止める（連続登録は後で拡張）
            }
        }

        startBtn.addEventListener("click", startScan);
        stopBtn.addEventListener("click", stopScan);
    </script>
</body>

</html>