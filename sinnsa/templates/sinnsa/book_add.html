{% extends "sinnsa/base.html" %}

{% block title %}本登録{% endblock %}

{% block content %}
<h1 class="page-title">本登録</h1>

{% if error %}
<p class="error">{{ error }}</p>
{% endif %}

<form method="post" class="add-wrap">
    {% csrf_token %}

    <div class="add-layout">
        <!-- 左：フォーム（ここを真ん中寄せしたい対象） -->
        <div class="form-col">
            <p>ISBN（必須）<br>
                <input type="text" name="isbn" id="isbn" placeholder="978xxxxxxxxxxxx">
            </p>

            <button type="button" id="fetch-book">ISBNから本情報を取得</button>
            <p id="fetch-status"></p>

            <h2>バーコードでISBN読み取り</h2>

            <button type="button" id="start-scan">カメラ起動</button>
            <button type="button" id="stop-scan" disabled>停止</button>

            <div id="scanner" class="scanner-box"></div>
            <p id="scan-status"></p>

            <hr>

            <p>タイトル（必須）<br>
                <input type="text" name="title" id="title" placeholder="本のタイトル">
            </p>

            <p>著者<br>
                <input type="text" name="author" id="author" placeholder="著者名">
            </p>

            <p>出版社<br>
                <input type="text" name="publisher" id="publisher" placeholder="出版社">
            </p>

            <p>表紙URL<br>
                <input type="text" name="cover_url" id="cover_url" placeholder="https://...">
            </p>

            <p>棚（任意）<br>
                <select name="shelf">
                    <option value="">未分類</option>
                    {% for s in shelves %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                    {% endfor %}
                </select>
            </p>

            <p>メモ<br>
                <textarea name="memo" rows="4"></textarea>
            </p>

            <button type="submit">登録</button>

            <p class="back-link"><a href="{% url 'book_list' %}">一覧へ戻る</a></p>
        </div>

        <!-- 右：表紙プレビュー（これは右に固定でOK） -->
        <aside class="cover-col">
            <h3>表紙プレビュー</h3>

            <div id="cover-preview-box" class="cover-preview-box">
                <span id="cover-preview-text">まだ画像がありません</span>
                <img id="cover-preview-img" src="" alt="cover">
            </div>

            <p class="hint">※ 表紙URL欄に貼るとここに表示されます</p>
            <div id="cover-suggest" class="cover-suggest"></div>
        </aside>
    </div>
</form>

<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script>
    const startBtn = document.getElementById("start-scan");
    const stopBtn = document.getElementById("stop-scan");
    const isbnInput = document.getElementById("isbn");
    const scanStatus = document.getElementById("scan-status");

    const fetchBtn = document.getElementById("fetch-book");
    const fetchStatus = document.getElementById("fetch-status");

    const coverInput = document.getElementById("cover_url");
    const coverSuggest = document.getElementById("cover-suggest");

    const previewImg = document.getElementById("cover-preview-img");
    const previewText = document.getElementById("cover-preview-text");


    let scanning = false;

    function normalizeIsbn(code) {
        return (code || "").replace(/[^0-9]/g, "");
    }

    function setCoverPreview(url) {
        const img = document.getElementById("cover-preview-img");
        const text = document.getElementById("cover-preview-text");
        const u = (url || "").trim();

        if (u) {
            text.style.display = "none";
            img.style.display = "block";
            img.src = u;
        } else {
            img.style.display = "none";
            img.removeAttribute("src");
            text.style.display = "block";
            text.textContent = "まだ画像がありません";
        }
    }

    coverInput.addEventListener("input", () => setCoverPreview(coverInput.value));

    function startScan() {
        if (scanning) return;
        scanning = true;

        scanStatus.textContent = "カメラ起動中...";
        startBtn.disabled = true;
        stopBtn.disabled = false;
        document.querySelector("#scanner").style.display = "block";

        Quagga.init({
            inputStream: {
                type: "LiveStream",
                target: document.querySelector("#scanner"),
                constraints: { facingMode: "environment" }
            },
            decoder: { readers: ["ean_reader", "ean_8_reader", "code_128_reader"] },
            locate: true
        }, function (err) {
            if (err) {
                scanStatus.textContent = "カメラ起動失敗";
                scanning = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                return;
            }
            Quagga.start();
            scanStatus.textContent = "バーコードを映してください";
        });

        Quagga.onDetected(onDetected);
    }

    function stopScan() {
        if (!scanning) return;
        scanning = false;

        try {
            Quagga.offDetected(onDetected);
            Quagga.stop();
        } catch (e) { }

        document.querySelector("#scanner").style.display = "none";
        scanStatus.textContent = "停止しました";
        startBtn.disabled = false;
        stopBtn.disabled = true;
    }

    function onDetected(result) {
        const code = normalizeIsbn(result?.codeResult?.code);
        if (code.length === 13) {
            isbnInput.value = code;
            scanStatus.textContent = "読み取り成功: " + code;
            stopScan();
        }
    }

    fetchBtn.addEventListener("click", async () => {
        const isbn = isbnInput.value.trim().replace(/[^0-9]/g, "");
        if (!isbn) {
            fetchStatus.textContent = "ISBNを入力してください";
            return;
        }

        fetchStatus.textContent = "取得中...";
        coverSuggest.innerHTML = "";

        try {
            const res = await fetch(`/isbn-lookup/?isbn=${encodeURIComponent(isbn)}`);
            const data = await res.json();

            if (!data.ok) {
                fetchStatus.textContent = data.error || "見つかりませんでした";
                setCoverPreview("");

                coverSuggest.innerHTML = `
          <p>画像が取れませんでした。検索して貼り付けできます。</p>
          <a href="https://www.google.com/search?tbm=isch&q=isbn+${isbn}" target="_blank" rel="noopener">
            画像検索（ISBN）
          </a>
        `;
                return;
            }

            document.getElementById("title").value = data.title || "";
            document.getElementById("author").value = data.author || "";
            document.getElementById("publisher").value = data.publisher || "";
            coverInput.value = data.cover_url || "";

            setCoverPreview(coverInput.value);

            if (!data.cover_url) {
                const title = data.title || isbn;
                coverSuggest.innerHTML = `
          <p>表紙が自動取得できませんでした。検索してURLを貼ってね。</p>
          <a href="https://www.google.com/search?tbm=isch&q=isbn+${isbn}" target="_blank" rel="noopener">画像検索（ISBN）</a><br>
          <a href="https://www.google.com/search?tbm=isch&q=${encodeURIComponent(title)}+表紙" target="_blank" rel="noopener">画像検索（タイトル）</a>
        `;
            }

            fetchStatus.textContent = "取得できました！";
        } catch (e) {
            fetchStatus.textContent = "通信エラー";
        }
    });

    startBtn.addEventListener("click", startScan);
    stopBtn.addEventListener("click", stopScan);
    setCoverPreview(coverInput.value);
</script>
{% endblock %}